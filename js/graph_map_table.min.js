function allowSaveGraph(){var a=myLine.toBase64Image();document.getElementById("time_graph").src=a}function makeGraph(a){election=elections[$(time_election).val()];graph_title="Percent of Votes by Hour";if(time_wards[$("#time_ward").val()]!="All"){graph_title+=", Ward "+time_wards[$("#time_ward").val()]}if($("#time_division").val()!="0"){graph_title+=", Division "+$("#time_division").val()}if($("#cum_sum").is(":checked")){graph_title="Cumulative Total Percent of Votes"}graph_title=election+", "+graph_title;Chart.defaults.global.defaultFontColor="#000000";myLineChart=new Chart(ctx_time,{type:"line",data:{labels:["7-8AM","8-9AM","9-10AM","10-11AM","11AM-12PM","12-1PM","1-2PM","2-3PM","3-4PM","4-5PM","5-6PM","6-7PM","7-8PM"],datasets:[{borderColor:"#000000",fill:false,data:a,onAnimationComplete:allowSaveGraph,}]},options:{responsive:true,maintainAspectRatio:false,legend:{display:false,},title:{display:true,position:"top",text:graph_title,fontSize:22},scales:{yAxes:[{ticks:{beginAtZero:true,fontSize:15},scaleLabel:{fontSize:22,fontColor:"#000000",display:true,labelString:"% of Votes"}}],xAxes:[{ticks:{fontSize:15}}]},tooltips:{mode:"index",intersect:false,},hover:{mode:"nearest",intersect:true}}});return(myLineChart)}function whenClicked(a){ward_num=a.sourceTarget.feature.properties.WARD_NUM;if(a.sourceTarget._mapToAdd._container.id=="results_map_div"){geojson.setStyle({color:"#28b78d"});results_map._layers[a.sourceTarget._leaflet_id].bringToFront();results_map._layers[a.sourceTarget._leaflet_id].setStyle({color:"#BA0C2F"});ward_dropdown="#results_ward";ward_num=results_wards.indexOf(ward_num)}if(a.sourceTarget._mapToAdd._container.id=="choices_map_div"){geojson.setStyle({color:"#28b78d"});choices_map._layers[a.sourceTarget._leaflet_id].bringToFront();choices_map._layers[a.sourceTarget._leaflet_id].setStyle({color:"#BA0C2F"});ward_dropdown="#choices_ward";ward_num=choices_wards.indexOf(ward_num)}if(a.sourceTarget._mapToAdd._container.id=="cand_comb_map_div"){geojson.setStyle({color:"#28b78d"});cand_comb_map._layers[a.sourceTarget._leaflet_id].bringToFront();cand_comb_map._layers[a.sourceTarget._leaflet_id].setStyle({color:"#BA0C2F"});ward_dropdown="#cand_comb_ward";ward_num=cand_comb_wards.indexOf(ward_num)}if(a.sourceTarget._mapToAdd._container.id=="time_map_div"){geojson.setStyle({color:"#28b78d"});time_map._layers[a.sourceTarget._leaflet_id].bringToFront();time_map._layers[a.sourceTarget._leaflet_id].setStyle({color:"#BA0C2F"});ward_dropdown="#time_ward";ward_num=time_wards.indexOf(ward_num)}$(ward_dropdown).val(ward_num);$(ward_dropdown).trigger("chosen:updated");if(a.sourceTarget._mapToAdd._container.id=="results_map_div"){resultsChange()}else{if(a.sourceTarget._mapToAdd._container.id=="choices_map_div"){choicesChange()}else{if(a.sourceTarget._mapToAdd._container.id=="time_map_div"){timeChange()}else{if(a.sourceTarget._mapToAdd._container.id=="cand_comb_map_div"){candCombChange()}}}}}function onEachFeature(b,a){a.on({click:whenClicked})}function makeTable(g,d,e){final_data=d;ward=cand_comb_wards[$("#cand_comb_ward").val()];if(ward!="All"){division=cand_comb_division[$("#cand_comb_division").val()];if(division=="0"){division="All"}final_data=[];for(var b=0;b<d.length;b++){if(d[b].division==division){final_data.push(d[b])}}}final_data=_.map(final_data,function(h){return _.omit(h,"division")});final_data=_.map(final_data,function(h){return _.omit(h,0)});data_keys=_.keys(final_data[0]);for(var a=0;a<final_data.length;a++){for(f=0;f<data_keys.length;f++){final_data[a][data_keys[f]]=final_data[a][data_keys[f]].replace(/"/g,"")}}final_data[0][0]="";if(_.keys(final_data[0]).toString()==_.keys(final_data[1]).toString()){final_data.shift()}z=[];e=e.split(",");e=e.filter(function(h){return h!=="division"});delete (final_data[0]["0"]);for(var f=0;f<e.length;f++){z.push({data:e[f],title:final_data[0][e[f]],className:"dt-head-right dt-body-right"})}col_headers=final_data[0];final_data.shift();var c=$("#table").DataTable({data:final_data,columns:z,stripe:true,hover:true,paging:false,searching:false,ordering:false,bAutoWidth:true,bInfo:false,fixedColumns:true,order:[1,"desc"],scrollX:true,sScrollXInner:"100%",sScrollX:"100%"});$("#table_wrapper").css("width","100%");$($.fn.dataTable.tables(true)).DataTable().columns.adjust().responsive.recalc();return c}function updateTable(){cand_data=getData("cand_comb");cand_data=cand_data.split("\n");cand_data.pop();headers=cand_data[0];cand_data=data_object_fun(cand_data,headers);cand_data.shift();table.destroy();$("#table").empty();table=makeTable("#table",cand_data,headers)}function updateGraph(){graph.destroy();graph_data=getGraphData();subsetted_graph_data=subsetGraphData(graph_data);graph=makeGraph(subsetted_graph_data);return(graph)}function updateChart(b,a){b.destroy();makeChart(a)}function makeChart(a){Chart.defaults.global.defaultFontColor="#000000";data=getData(a);data=subsetData(data,a);data=formatData(data,a);title_text=data[1];data=data[0];if(a=="choices"){chart_div=ctx_choices;chart_type="bar";choices_chart=new Chart(chart_div,{type:chart_type,data:data,options:{responsive:true,maintainAspectRatio:false,legend:{display:false},title:{display:true,position:"top",text:title_text,fontSize:22},scales:{yAxes:[{ticks:{beginAtZero:true,fontSize:15},scaleLabel:{fontSize:22,display:true,labelString:"% of Votes"}}],xAxes:[{scaleLabel:{fontSize:22,display:true,labelString:"# of Selections Made"},ticks:{fontSize:15}}]},tooltips:{enabled:true,mode:"single",callbacks:{label:function(b,c){return" % who voted for "+b.xLabel+" choices:"+b.yLabel}}}}})}if(a=="results"){chart_type="horizontalBar";chart_div=ctx_results;results_chart=new Chart(chart_div,{type:chart_type,data:data,options:{responsive:true,maintainAspectRatio:false,legend:{display:false},title:{display:true,position:"top",text:title_text,fontSize:22},scales:{xAxes:[{ticks:{beginAtZero:true,fontSize:15,userCallback:function(d,c,b){d=d.toString();d=d.split(/(?=(?:...)*$)/);d=d.join(",");return d}},scaleLabel:{fontSize:20,display:true,labelString:"# of Votes"}}]},tooltips:{enabled:true,mode:"single",callbacks:{label:function(b,c){value=b.xLabel;value=value.toString();value=value.split(/(?=(?:...)*$)/);value=value.join(",");return value}}}}})}};